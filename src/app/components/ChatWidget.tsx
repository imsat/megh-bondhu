"use client"

import { useState, useRef, useEffect } from "react"
import { Send, Cloud, X, MessageCircle } from "lucide-react"

interface Message {
    id: string
    type: "bot" | "user"
    content: string
    options?: Array<{ label: string; action: string }>
}

const MENU_OPTIONS = [
    { label: "ЁЯМбя╕П ржЖржЬржХрзЗрж░ ржЖржмрж╣рж╛ржУржпрж╝рж╛", action: "current_weather" },
    { label: "ЁЯУЕ ржнржмрж┐рж╖рзНржпрждрзЗрж░ ржЖржмрж╣рж╛ржУржпрж╝рж╛", action: "forecast" },
    { label: "ЁЯУЪ рж╕ржЪрзЗрждржирждрж╛", action: "awareness" },
    { label: "ЁЯПе ржХрзНрж▓рж┐ржирж┐ржХ ржЦрзБржБржЬрзБржи", action: "clinics" },
]

const AWARENESS_OPTIONS = [
    { label: "ЁЯМК ржмржирзНржпрж╛ рж╕ржЪрзЗрждржирждрж╛", action: "flood" },
    { label: "ЁЯМкя╕П ржШрзВрж░рзНржгрж┐ржЭржбрж╝ рж╕ржЪрзЗрждржирждрж╛", action: "cyclone" },
    { label: "ЁЯФе рждрж╛ржкржкрзНрж░ржмрж╛рж╣ рж╕ржЪрзЗрждржирждрж╛", action: "heatwave" },
]

export default function ChatWidget() {
    const [isOpen, setIsOpen] = useState(false)
    const [messages, setMessages] = useState<Message[]>([
        {
            id: "1",
            type: "bot",
            content: "рж╕рзНржмрж╛ржЧрждржо! ЁЯСЛ ржЖржорж┐ ржорзЗржШржмржирзНржзрзБ ржмржЯред ржЖржкржирж┐ ржХрзА ржЬрж╛ржирждрзЗ ржЪрж╛ржи?",
            options: MENU_OPTIONS,
        },
    ])
    const [input, setInput] = useState("")
    const [loading, setLoading] = useState(false)
    const messagesEndRef = useRef<HTMLDivElement>(null)

    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" })
    }

    useEffect(() => {
        scrollToBottom()
    }, [messages])

    const handleOptionClick = async (action: string) => {
        const userMessage: Message = {
            id: Date.now().toString(),
            type: "user",
            content: action,
        }

        setMessages((prev) => [...prev, userMessage])
        setLoading(true)

        setTimeout(() => {
            let botResponse: Message

            switch (action) {
                case "current_weather":
                    botResponse = {
                        id: (Date.now() + 1).toString(),
                        type: "bot",
                        content: `ЁЯПЩя╕П ржврж╛ржХрж╛рж░ ржЖржмрж╣рж╛ржУржпрж╝рж╛\n\nЁЯМбя╕П рждрж╛ржкржорж╛рждрзНрж░рж╛: 28┬░C\nтШБя╕П ржЕржмрж╕рзНржерж╛: ржЖржВрж╢рж┐ржХ ржорзЗржШрж▓рж╛\nЁЯТз ржЖрж░рзНржжрзНрж░рждрж╛: 72%\nЁЯТи ржмрж╛ржпрж╝рзБ ржЧрждрж┐: 12 km/h`,
                    }
                    break

                case "forecast":
                    botResponse = {
                        id: (Date.now() + 1).toString(),
                        type: "bot",
                        content: `ЁЯУЕ ржЖржЧрж╛ржорзА ржжрж┐ржирзЗрж░ ржкрзВрж░рзНржмрж╛ржнрж╛рж╕ (ржврж╛ржХрж╛)\n\nЁЯУЖ ржЖржЧрж╛ржорзАржХрж╛рж▓: 26-30┬░C, ржмрзГрж╖рзНржЯрж┐рж░ рж╕ржорзНржнрж╛ржмржирж╛ 40%\nЁЯУЖ ржкрж░рзЗрж░ ржжрж┐ржи: 25-29┬░C, ржорзЗржШрж▓рж╛\nЁЯУЖ рждрж┐ржи ржжрж┐ржи ржкрж░: 27-31┬░C, рж░рзМржжрзНрж░рзЛржЬрзНржЬрзНржмрж▓`,
                    }
                    break

                case "awareness":
                    botResponse = {
                        id: (Date.now() + 1).toString(),
                        type: "bot",
                        content: "рж╕ржЪрзЗрждржирждрж╛ ржмрж┐рж╖ржпрж╝ ржмрзЗржЫрзЗ ржирж┐ржи:",
                        options: AWARENESS_OPTIONS,
                    }
                    break

                case "flood":
                    botResponse = {
                        id: (Date.now() + 1).toString(),
                        type: "bot",
                        content: `ЁЯУШ ржмржирзНржпрж╛ рж╕ржЪрзЗрждржирждрж╛ ржЧрж╛ржЗржб\n\nтЬУ ржирж┐рж░рж╛ржкржж рж╕рзНржерж╛ржирзЗ ржпрж╛ржи\nтЬУ ржЬрж░рзБрж░рж┐ рж╕рж╛ржоржЧрзНрж░рзА ржкрзНрж░рж╕рзНрждрзБржд рж░рж╛ржЦрзБржи\nтЬУ рж╕рзНржерж╛ржирзАржпрж╝ ржХрж░рзНрждрзГржкржХрзНрж╖рзЗрж░ ржирж┐рж░рзНржжрзЗрж╢ржирж╛ ржЕржирзБрж╕рж░ржг ржХрж░рзБржи\nтЬУ ржкрж░рж┐ржмрж╛рж░рзЗрж░ рж╕рж╛ржерзЗ ржпрзЛржЧрж╛ржпрзЛржЧ рж░рж╛ржЦрзБржи`,
                    }
                    break

                case "cyclone":
                    botResponse = {
                        id: (Date.now() + 1).toString(),
                        type: "bot",
                        content: `ЁЯУШ ржШрзВрж░рзНржгрж┐ржЭржбрж╝ рж╕ржЪрзЗрждржирждрж╛ ржЧрж╛ржЗржб\n\nтЬУ ржШрж░рзЗрж░ ржнрж┐рждрж░рзЗ ржерж╛ржХрзБржи\nтЬУ ржЬрж╛ржирж╛рж▓рж╛ ржПржмржВ ржжрж░ржЬрж╛ ржмржирзНржз ржХрж░рзБржи\nтЬУ рж╢ржХрзНрждрж┐рж╢рж╛рж▓рзА ржмрж╛рждрж╛рж╕ ржерзЗржХрзЗ ржжрзВрж░рзЗ ржерж╛ржХрзБржи\nтЬУ ржЬрж░рзБрж░рж┐ рж╕рзЗржмрж╛ ржиржорзНржмрж░ рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзБржи`,
                    }
                    break

                case "heatwave":
                    botResponse = {
                        id: (Date.now() + 1).toString(),
                        type: "bot",
                        content: `ЁЯУШ рждрж╛ржкржкрзНрж░ржмрж╛рж╣ рж╕ржЪрзЗрждржирждрж╛ ржЧрж╛ржЗржб\n\nтЬУ ржкрзНрж░ржЪрзБрж░ ржкрж╛ржирж┐ ржкрж╛ржи\nтЬУ рж╣рж╛рж▓ржХрж╛ рж░ржЩрзЗрж░ ржкрзЛрж╢рж╛ржХ ржкрж░рзБржи\nтЬУ ржжрзБржкрзБрж░рзЗ ржмрж╛ржЗрж░рзЗ ржпрж╛ржУржпрж╝рж╛ ржПржбрж╝рж┐ржпрж╝рзЗ ржЪрж▓рзБржи\nтЬУ ржмржпрж╝рж╕рзНржХ ржПржмржВ рж╢рж┐рж╢рзБржжрзЗрж░ ржпрждрзНржи ржирж┐ржи`,
                    }
                    break

                case "clinics":
                    botResponse = {
                        id: (Date.now() + 1).toString(),
                        type: "bot",
                        content: `ЁЯПе ржврж╛ржХрж╛ рж╢рж╣рж░рзЗрж░ ржХрзНрж▓рж┐ржирж┐ржХ\n\n1. ржврж╛ржХрж╛ ржорзЗржбрж┐ржХрзЗрж▓ ржХрж▓рзЗржЬ рж╣рж╛рж╕ржкрж╛рждрж╛рж▓\n   ЁЯУН рж╢рж╛рж╣ржмрж╛ржЧ, ржврж╛ржХрж╛\n   тШОя╕П +880-2-9661051\n\n2. ржмрж╛рж░ржбрзЗржо ржЬрзЗржирж╛рж░рзЗрж▓ рж╣рж╛рж╕ржкрж╛рждрж╛рж▓\n   ЁЯУН ржкрж╛ржирзНржержкрже, ржврж╛ржХрж╛\n   тШОя╕П +880-2-8611881`,
                    }
                    break

                default:
                    botResponse = {
                        id: (Date.now() + 1).toString(),
                        type: "bot",
                        content: "ржЖржорж┐ ржмрзБржЭрждрзЗ ржкрж╛рж░рж┐ржирж┐ред ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржорзЗржирзБ ржерзЗржХрзЗ ржПржХржЯрж┐ ржмрж┐ржХрж▓рзНржк ржмрзЗржЫрзЗ ржирж┐ржиред",
                        options: MENU_OPTIONS,
                    }
            }

            setMessages((prev) => [...prev, botResponse])
            setLoading(false)
        }, 500)
    }

    const handleSendMessage = () => {
        if (input.trim()) {
            const userMessage: Message = {
                id: Date.now().toString(),
                type: "user",
                content: input,
            }

            setMessages((prev) => [...prev, userMessage])
            setInput("")
            setLoading(true)

            setTimeout(() => {
                const botResponse: Message = {
                    id: (Date.now() + 1).toString(),
                    type: "bot",
                    content: "ржЖржорж┐ ржмрзБржЭрждрзЗ ржкрж╛рж░рж┐ржирж┐ред ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржорзЗржирзБ ржерзЗржХрзЗ ржПржХржЯрж┐ ржмрж┐ржХрж▓рзНржк ржмрзЗржЫрзЗ ржирж┐ржиред",
                    options: MENU_OPTIONS,
                }

                setMessages((prev) => [...prev, botResponse])
                setLoading(false)
            }, 500)
        }
    }

    return (
        <>
            <button
                onClick={() => setIsOpen(!isOpen)}
                className="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg flex items-center justify-center transition-all duration-300 z-40 hover:scale-110"
                aria-label="Open chat"
            >
                {isOpen ? <X className="w-6 h-6" /> : <MessageCircle className="w-6 h-6" />}
            </button>

            {isOpen && (
                <div className="fixed bottom-24 right-6 w-96 h-96 bg-white rounded-lg shadow-2xl flex flex-col z-50 overflow-hidden">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-blue-600 to-cyan-600 text-white p-4">
                        <div className="flex items-center gap-3">
                            <Cloud className="w-5 h-5" />
                            <div>
                                <h1 className="text-lg font-bold">ржорзЗржШржмржирзНржзрзБ ржмржЯ</h1>
                                <p className="text-xs text-blue-100">ржЖржмрж╣рж╛ржУржпрж╝рж╛ ржУ рж╕ржЪрзЗрждржирждрж╛ рж╕рж╣рж╛ржпрж╝ржХ</p>
                            </div>
                        </div>
                    </div>

                    {/* Messages Container */}
                    <div className="flex-1 overflow-y-auto p-3 space-y-3 bg-gray-50">
                        {messages.map((message) => (
                            <div key={message.id} className={`flex ${message.type === "user" ? "justify-end" : "justify-start"}`}>
                                <div
                                    className={`max-w-xs px-3 py-2 rounded-lg text-sm ${
                                        message.type === "user"
                                            ? "bg-blue-600 text-white rounded-br-none"
                                            : "bg-white text-gray-800 border border-gray-200 rounded-bl-none"
                                    }`}
                                >
                                    <p className="whitespace-pre-wrap">{message.content}</p>

                                    {message.options && (
                                        <div className="mt-2 space-y-1">
                                            {message.options.map((option, idx) => (
                                                <button
                                                    key={idx}
                                                    onClick={() => handleOptionClick(option.action)}
                                                    disabled={loading}
                                                    className={`w-full text-left px-2 py-1 rounded text-xs font-medium transition-colors ${
                                                        message.type === "user"
                                                            ? "bg-blue-500 border border-blue-400 text-white hover:bg-blue-600 disabled:opacity-50"
                                                            : "bg-gray-100 border border-gray-300 text-gray-800 hover:bg-gray-200 disabled:opacity-50"
                                                    }`}
                                                >
                                                    {option.label}
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}

                        {loading && (
                            <div className="flex justify-start">
                                <div className="bg-white text-gray-800 border border-gray-200 px-3 py-2 rounded-lg rounded-bl-none">
                                    <div className="flex gap-2">
                                        <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                        <div
                                            className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"
                                            style={{ animationDelay: "0.1s" }}
                                        ></div>
                                        <div
                                            className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"
                                            style={{ animationDelay: "0.2s" }}
                                        ></div>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div ref={messagesEndRef} />
                    </div>

                    {/* Input Area */}
                    <div className="border-t border-gray-200 p-3 bg-white">
                        <div className="flex gap-2">
                            <input
                                type="text"
                                placeholder="ржмрж╛рж░рзНрждрж╛ рж▓рж┐ржЦрзБржи..."
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyPress={(e) => e.key === "Enter" && handleSendMessage()}
                                disabled={loading}
                                className="flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"
                            />
                            <button
                                onClick={handleSendMessage}
                                disabled={loading || !input.trim()}
                                className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded font-medium transition-colors disabled:opacity-50 flex items-center gap-1"
                            >
                                <Send className="w-4 h-4" />
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </>
    )
}
